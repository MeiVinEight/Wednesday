buildscript {
	repositories {
		maven { url 'https://mirrors.cloud.tencent.com/gradle/'}
		maven { url 'https://mirrors.cloud.tencent.com/nexus/repository/maven-public/' }
		maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
		maven { url 'https://maven.aliyun.com/nexus/content/groups/public' }
		maven { url 'https://maven.aliyun.com/nexus/content/repositories/jcenter' }
		maven { url 'https://maven.aliyun.com/repository/jcenter' }
		maven { url 'https://maven.aliyun.com/repository/google' }
		maven { url 'https://www.jitpack.io' }
		maven { url 'https://central.sonatype.com/repository/maven-snapshots/' }
		mavenCentral()
		gradlePluginPortal()
		google()
	}
}

plugins {
	id 'java'
}

repositories {
	maven { url 'https://mirrors.cloud.tencent.com/gradle/'}
	maven { url 'https://mirrors.cloud.tencent.com/nexus/repository/maven-public/' }
	maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }
	maven { url 'https://maven.aliyun.com/nexus/content/groups/public' }
	maven { url 'https://maven.aliyun.com/nexus/content/repositories/jcenter' }
	maven { url 'https://maven.aliyun.com/repository/jcenter' }
	maven { url 'https://maven.aliyun.com/repository/google' }
	maven { url 'https://www.jitpack.io' }
	flatDir { dir 'libs' }
	mavenCentral()
	gradlePluginPortal()
	google()
}

group = "org.mve"
version = "1.0.0-Lambda"
java.sourceCompatibility = JavaVersion.VERSION_17
java.targetCompatibility = JavaVersion.VERSION_17

dependencies {
	implementation project(":Woden")
	// https://mvnrepository.com/artifact/org.fusesource.jansi/jansi
	implementation group: 'org.fusesource.jansi', name: 'jansi', version: '2.4.2'
	// https://mvnrepository.com/artifact/top.mrxiaom.mirai/overflow-core
	implementation group: 'top.mrxiaom.mirai', name: 'overflow-core', version: '1.0.8'
	// https://mvnrepository.com/artifact/org.ow2.asm/asm
	implementation group: 'org.ow2.asm', name: 'asm', version: '9.9'
	implementation group: '', name: 'mysql-connector-j', version: '9.5.0'
	implementation group: '', name: 'ReflectionFX', version: '-SNAPSHOT'
}

tasks.register('sourceJar', Jar) {
	dependsOn classes
	archiveClassifier = 'sources'
	from sourceSets.main.allSource
}

tasks.register("run", JavaExec)  {
	group = "run"
	classpath = sourceSets.main.runtimeClasspath
	mainClass = "org.mve.Main"
}

tasks.register("runWoden", JavaExec) {
	group = "run"
	classpath = sourceSets.main.runtimeClasspath
	mainClass = "org.mve.woden.Woden"
}

tasks.register("scripts") {
	File libsDir = new File(projectDir, "libs")
	File[] libs = libsDir.listFiles()
	if (libs == null)
		return


	if (File.pathSeparatorChar == (':' as char))
	{
		File wodenSh = new File(projectDir, "woden.sh")
		try (FileOutputStream fout = new FileOutputStream(wodenSh))
		{
			PrintStream out = new PrintStream(fout)
			out.println("CLASSPATH=")
			for (File libFile : libs)
			{
				String absPath = libFile.getAbsolutePath()
				out.println("CLASSPATH=\$CLASSPATH:\"" + absPath + '\"')
			}
			out.println("CLASSPATH=\"\$CLASSPATH\"")
			out.println("OPTIONS=")
			if (!max_memory.empty)
				out.println("OPTIONS=\$OPTIONS\" -Xmx" + max_memory + '\"')

			out.println("java -classpath \"\$CLASSPATH\" \$OPTIONS org.mve.Main")
		}
		println("Extract scripts: " + wodenSh)
	}
	else if (File.pathSeparatorChar == (';' as char))
	{
		File wodenBat = new File(projectDir, "woden.bat")
		try (FileOutputStream fout = new FileOutputStream(wodenBat))
		{
			PrintStream out = new PrintStream(fout)
			out.println("@echo off")
			for (File libFile : libs)
			{
				String absPath = libFile.getAbsolutePath().replace(File.separatorChar, ('/' as char))
				out.println("SET CLASSPATH=%CLASSPATH%" + absPath + ';')
			}
			out.println("SET CLASSPATH=\"%CLASSPATH%\"")
			if (!max_memory.empty)
				out.println("SET OPTIONS=%OPTIONS% -Xmx" + max_memory)
			out.println("java -classpath %CLASSPATH% %OPTIONS% org.mve.Main")
		}
		println("Extract scripts: " + wodenBat)
	}
}

tasks.jar.configure {
	destinationDirectory = file("libs")
	finalizedBy(sourceJar)
}